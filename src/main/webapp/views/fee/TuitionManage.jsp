<%@ page language="java" contentType="text/html;charset=UTF-8" pageEncoding="UTF-8"%>
    <!DOCTYPE html>
    <html lang="zh-TW">

    <head>
        <meta charset="UTF-8">
        <title>OLDÂ≠∏Ë≤ªÁÆ°ÁêÜ</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
            }

            .container {
                padding: 2rem;
                max-width: 1400px;
                margin: 0 auto;
            }

            .header {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 2rem;
                margin-bottom: 2rem;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 1rem;
                animation: fadeIn 0.5s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .header-title {
                font-size: 28px;
                font-weight: 700;
                background: linear-gradient(135deg, #667eea, #764ba2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .header-title::before {
                content: "üí∞";
                font-size: 32px;
            }

            .search-container {
                flex: 1;
                max-width: 400px;
                margin: 0 2rem;
            }

            .search-input {
                width: 100%;
                padding: 12px 20px;
                border: 2px solid #e2e8f0;
                border-radius: 25px;
                font-size: 16px;
                transition: all 0.3s ease;
                background: white;
            }

            .search-input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .header-actions {
                display: flex;
                gap: 1rem;
                align-items: center;
            }

            .btn {
                border: none;
                border-radius: 12px;
                padding: 12px 24px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

            .btn-success {
                background: linear-gradient(135deg, #48bb78, #38a169);
                color: white;
                box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
            }

            .btn-success:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
            }

            .btn-warning {
                background: linear-gradient(135deg, #ed8936, #dd6b20);
                color: white;
                box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
            }

            .btn-warning:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(237, 137, 54, 0.4);
            }

            .btn-danger {
                background: linear-gradient(135deg, #f56565, #e53e3e);
                color: white;
                box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
            }

            .btn-danger:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(245, 101, 101, 0.4);
            }

            .btn-secondary {
                background: linear-gradient(135deg, #a0aec0, #718096);
                color: white;
            }

            .btn-sm {
                padding: 6px 12px;
                font-size: 14px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .stat-card {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 2rem;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .stat-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            }

            .stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: var(--card-color);
            }

            .stat-card.blue {
                --card-color: linear-gradient(135deg, #60a5fa, #3b82f6);
            }

            .stat-card.orange {
                --card-color: linear-gradient(135deg, #fbbf24, #f59e0b);
            }

            .stat-card.green {
                --card-color: linear-gradient(135deg, #22c55e, #16a34a);
            }

            .stat-card.red {
                --card-color: linear-gradient(135deg, #ef4444, #dc2626);
            }

            .stat-card::before {
                background: var(--card-color);
            }

            .stat-label {
                font-size: 14px;
                color: #64748b;
                margin-bottom: 0.5rem;
                font-weight: 500;
            }

            .stat-amount {
                font-size: 32px;
                font-weight: 700;
                color: #1e293b;
                margin-bottom: 0.5rem;
            }

            .stat-desc {
                font-size: 14px;
                color: #94a3b8;
            }

            .table-section {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .table-header {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 1.5rem 2rem;
                font-size: 20px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .table-header::before {
                content: "üìä";
                font-size: 24px;
            }

            .table-container {
                padding: 2rem;
                overflow-x: auto;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            }

            th {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 1rem;
                font-weight: 600;
                font-size: 14px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                text-align: center;
            }

            td {
                padding: 1rem;
                text-align: center;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                vertical-align: middle;
            }

            tr {
                transition: all 0.3s ease;
            }

            tr:hover {
                background: rgba(102, 126, 234, 0.05);
                transform: scale(1.01);
            }

            tr:last-child td {
                border-bottom: none;
            }

            .status {
                display: inline-block;
                padding: 6px 16px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status.pending {
                background: rgba(251, 191, 36, 0.1);
                color: #b45309;
                border: 1px solid rgba(251, 191, 36, 0.3);
            }

            .status.paid {
                background: rgba(34, 197, 94, 0.1);
                color: #15803d;
                border: 1px solid rgba(34, 197, 94, 0.3);
            }

            .status.overdue {
                background: rgba(239, 68, 68, 0.1);
                color: #b91c1c;
                border: 1px solid rgba(239, 68, 68, 0.3);
            }

            .amount-unpaid {
                color: #ef4444;
                font-weight: 600;
            }

            .amount-paid {
                color: #22c55e;
                font-weight: 600;
            }

            .remark-cell {
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                cursor: help;
            }

            /* Modal Ê®£Âºè */
            .modal-content {
                border: none;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            }

            .modal-header {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border-radius: 20px 20px 0 0;
                padding: 1.5rem 2rem;
            }

            .modal-title {
                font-weight: 600;
                font-size: 20px;
            }

            .btn-close {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                opacity: 0.8;
            }

            .btn-close:hover {
                opacity: 1;
                background: rgba(255, 255, 255, 0.3);
            }

            .modal-body {
                padding: 2rem;
            }

            .form-label {
                font-weight: 600;
                color: #374151;
                margin-bottom: 0.5rem;
            }

            .form-control,
            .form-select {
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                padding: 12px 16px;
                transition: all 0.3s ease;
            }

            .form-control:focus,
            .form-select:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .fee-item {
                background: rgba(102, 126, 234, 0.05);
                border: 2px solid rgba(102, 126, 234, 0.1);
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: all 0.3s ease;
            }

            .fee-item:hover {
                background: rgba(102, 126, 234, 0.1);
                border-color: rgba(102, 126, 234, 0.2);
            }

            .discount-section {
                background: rgba(251, 191, 36, 0.05);
                border: 2px solid rgba(251, 191, 36, 0.2);
                border-radius: 12px;
                padding: 1.5rem;
                margin: 1.5rem 0;
            }

            .section-title {
                font-size: 18px;
                font-weight: 600;
                color: #374151;
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            /* ÈüøÊáâÂºèË®≠Ë®à */
            @media (max-width: 768px) {
                .container {
                    padding: 1rem;
                }

                .header {
                    flex-direction: column;
                    text-align: center;
                }

                .search-container {
                    margin: 1rem 0;
                    max-width: 100%;
                }

                .header-actions {
                    flex-wrap: wrap;
                    justify-content: center;
                }

                .stats-grid {
                    grid-template-columns: 1fr;
                }

                .table-container {
                    padding: 1rem;
                }

                table {
                    font-size: 14px;
                }

                th,
                td {
                    padding: 0.5rem;
                }

                .modal-body {
                    padding: 1rem;
                }
            }

            /* Âä†ËºâÂãïÁï´ */
            .loading {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 3rem;
                color: #667eea;
            }

            .loading::before {
                content: "‚è≥";
                font-size: 32px;
                animation: spin 2s linear infinite;
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            /* ÂàÜÈ†ÅÊ®£Âºè */
            #pagination {
                margin-top: 2rem;
                text-align: center;
            }

            .pagination-btn {
                background: rgba(102, 126, 234, 0.1);
                border: 1px solid rgba(102, 126, 234, 0.3);
                color: #667eea;
                padding: 8px 16px;
                margin: 0 4px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .pagination-btn:hover,
            .pagination-btn.active {
                background: #667eea;
                color: white;
            }
        </style>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </head>

    <body>
        <div class="container">
            <!-- Header Section -->
            <div class="header">
                <div class="header-title">Â≠∏Ë≤ªÁÆ°ÁêÜÁ≥ªÁµ±</div>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="üîç ÊêúÂ∞ãÂ≠∏ÁîüÔºàÂ≠∏Ëôü„ÄÅÂßìÂêç„ÄÅÂç°ËôüÔºâ">
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#tuitionModal">
                        <i class="bi bi-plus-circle"></i>
                        Êñ∞Â¢ûÂ≠∏Ë≤ªÂ∏≥ÂñÆ
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-label">üí∞ ÂæÖÊî∂ÈáëÈ°çË®àÁÆó</div>
                    <div class="stat-amount" id="unpaidAmount">NT$ 0</div>
                    <div class="stat-desc">ÂÆåÂÖ®Êú™‰ªò</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">‚è≥ ÂàÜÊúüÊú™‰ªò</div>
                    <div class="stat-amount" id="partialAmount">NT$ 0</div>
                    <div class="stat-desc">ÈÉ®ÂàÜÂ∑≤‰ªò</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">‚úÖ Â∑≤Êî∂Á∏ΩÈ°ç</div>
                    <div class="stat-amount" id="paidAmount">NT$ 0</div>
                    <div class="stat-desc">Â≠∏Ë≤ªÁ∏ΩÂ≠òÊ¨æ</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">‚ö†Ô∏è ÈÄæÊúüÈáëÈ°ç</div>
                    <div class="stat-amount" id="overdueAmount">NT$ 0</div>
                    <div class="stat-desc">Ë´ãÁ´ãÂç≥ËôïÁêÜ</div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="table-section">
                <div class="table-header">Â≠∏Ë≤ªË®òÈåÑÂàóË°®</div>
                <div class="table-container">
                    <div id="tuitionTable">
                        <table>
                            <thead>
                                <tr>
                                    <th>üìã ÈÄöÁü•Á∑®Ëôü</th>
                                    <th>üë§ Â≠∏ÁîüÂßìÂêç</th>
                                    <th>üìö Ë™≤Á®ãÂêçÁ®±</th>
                                    <th>üí∞ Â≠∏Ë≤ªÁ∏ΩÈ°ç</th>
                                    <th>‚úÖ Â∑≤‰ªòÈáëÈ°ç</th>
                                    <th>‚ùå Êú™Áπ≥ÈáëÈ°ç</th>
                                    <th>üìÖ Áπ≥Ë≤ªÊúüÈôê</th>
                                    <th>üìä Áπ≥Ë≤ªÁãÄÊÖã</th>
                                    <th>üìù ÂÇôË®ª</th>
                                    <th>‚öôÔ∏è Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Ë≥áÊñôÂ∞áÈÄèÈÅé JavaScript ÂãïÊÖãËºâÂÖ• -->
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination"></div>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÂ≠∏Ë≤ª Modal -->
            <div class="modal fade" id="tuitionModal" tabindex="-1" aria-labelledby="tuitionModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="tuitionModalLabel">üìã ÂâµÂª∫Â≠∏Ë≤ªÈÄöÁü•</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="feeForm" onsubmit="insert(event)">
                                <!-- Âü∫Êú¨Ë≥áÊñô -->
                                <div class="mb-4">
                                    <h6 class="section-title">
                                        <i class="bi bi-person-fill"></i>
                                        Âü∫Êú¨Ë≥áÊñô
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Â≠∏Áîü *</label>
                                            <select id="studentDropdown" class="form-select" name="student_id" required>
                                                <option value="">Ë´ãÈÅ∏ÊìáÂ≠∏Áîü</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Á¥ÑÂÆöÁπ≥Ë≤ªÊó•Êúü *</label>
                                            <input type="date" class="form-control" name="due_date" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Ë™≤Á®ã *</label>
                                            <select id="courseDropdown" class="form-select" name="course_id" required>
                                                <option value="">Ë´ãÈÅ∏ÊìáË™≤Á®ã</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">‰øÆÊ•≠ÈñãÂßãÊó• *</label>
                                            <input type="date" class="form-control" name="start_date" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">‰øÆÊ•≠ÁµêÊùüÊó• *</label>
                                            <input type="date" class="form-control" name="end_date" required>
                                        </div>
                                    </div>
                                </div>

                                <!-- ÁßëÁõÆËàáË≤ªÁî® -->
                                <div class="mb-4">
                                    <h6 class="section-title">
                                        <i class="bi bi-book-fill"></i>
                                        ÁßëÁõÆËàáË≤ªÁî®
                                    </h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <select class="form-select" name="subject" id="subject">
                                                <option value="">Ë´ãÈÅ∏ÊìáÁßëÁõÆ</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" name="amount" id="amount"
                                                placeholder="Ëº∏ÂÖ•ÈáëÈ°ç">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-success w-100" id="addFeeBtn">
                                                <i class="bi bi-plus"></i>
                                                Êñ∞Â¢ûË≤ªÁî®
                                            </button>
                                        </div>
                                    </div>
                                    <div id="feeList"></div>
                                </div>

                                <!-- ÊäòÊâ£Ë®≠ÂÆö -->
                                <div class="discount-section">
                                    <h6 class="section-title">
                                        <i class="bi bi-percent"></i>
                                        ÊäòÊâ£Ë®≠ÂÆö
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Â≠∏Ë≤ªÂÑ™ÊÉ†</label>
                                            <input type="number" class="form-control" name="discount_scholar"
                                                placeholder="Ëº∏ÂÖ•ÊäòÊâ£ÈáëÈ°ç">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">ÂÖÑÂºüÂßäÂ¶πÊäòÊâ£</label>
                                            <input type="number" class="form-control" name="discount_sibling"
                                                placeholder="Ëº∏ÂÖ•ÊäòÊâ£ÈáëÈ°ç">
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
						<label class="form-label">ÂØ¶Êî∂ÈáëÈ°ç</label> <input type="number"
							class="form-control" id="net_amount" name="net_amount" >
					</div>
                                        
                                        
                                    </div>
                                </div>

                                <!-- ÂÇôË®ª -->
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-chat-text"></i>
                                        ÂÇôË®ª
                                    </label>
                                    <textarea class="form-control" name="remark" rows="3"
                                        placeholder="Ë´ãËº∏ÂÖ•ÂÇôË®ª (ÈÅ∏Â°´)"></textarea>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle"></i>
                                        Á¢∫Ë™çÂâµÂª∫
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Á∑®ËºØÂ≠∏Ë≤ª Modal -->
            <div class="modal fade" id="editTuitionModal" tabindex="-1" aria-labelledby="editTuitionModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editTuitionModalLabel">
                                <i class="bi bi-pencil-square"></i>
                                Á∑®ËºØÂ≠∏Ë≤ªË≥áÊñô
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ÈóúÈñâ"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editForm" onsubmit="updateTuition(event)">
                    		<input type="hidden" name="payment_id">
                               <input type="hidden" name="course_id"> 

                                <div class="mb-3">
                                    <label class="form-label">Â≠∏ÁîüÂßìÂêç</label>
                                    <input type="text" class="form-control" name="student_name" readonly
                                        style="background-color: #f8f9fa;">
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Ë™≤Á®ãÂêçÁ®±</label>
                                        <input type="text" class="form-control" name="course_name" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ÈáëÈ°ç</label>
                                        <input type="number" class="form-control" name="amount" required>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Áπ≥Ë≤ªÁãÄÊÖã</label>
                                        <select name="pay_status" class="form-control" required>
  <option value="unpaid">ÂæÖÁπ≥‰∏≠</option>
  <option value="paid">Â∑≤‰ªòÊ¨æ</option>
  <option value="partial">ÂàÜÊúü‰ªòÊ¨æ</option>
  <option value="refunded">Â∑≤ÈÄÄË≤ª</option>
</select>
                                        
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Áπ≥Ë≤ªÊúüÈôê</label>
                                        <input type="date" class="form-control" name="pay_date" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">ÂÇôË®ª</label>
                                    <textarea class="form-control" name="remark" rows="3"></textarea>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i>
                                        ÂÑ≤Â≠ò‰øÆÊîπ
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // È†ÅÈù¢‰∏ÄËºâÂÖ•Â∞±ËºâË≥áÊñô
            document.addEventListener("DOMContentLoaded", function () {
                loadTuitionData();
                loadStudents();
                loadCourses();
                loadSubjects();
            });

            function loadTuitionData() {
                const tableBody = document.querySelector("#tuitionTable tbody");
                tableBody.innerHTML = '<tr><td colspan="10" class="loading">ËºâÂÖ•‰∏≠...</td></tr>';

                fetch("${pageContext.request.contextPath}/apiGetAllPayment")
                    .then(res => res.json())
                    .then(data => {
                        console.log(data);
                        tableBody.innerHTML = ""; // Ê∏ÖÁ©∫ËºâÂÖ•ÊèêÁ§∫

                        // Ë®àÁÆóÁµ±Ë®àÊï∏Êìö
                        updateStatistics(data);

                        if (data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 3rem; color: #718096;">üì≠ ÁõÆÂâçÊ≤íÊúâÂ≠∏Ë≤ªË®òÈåÑ</td></tr>';
                            return;
                        }

                        data.forEach((item, index) => {
                            const row = document.createElement("tr");

                            // ÁøªË≠Ø payStatus
                            let payStatusText = '';
                            let statusClass = '';
                            switch (item.payStatus) {
                                case 'unpaid':
                                    payStatusText = 'ÂæÖÁπ≥‰∏≠';
                                    statusClass = 'pending';
                                    break;
                                case 'paid':
                                    payStatusText = 'Â∑≤‰ªòÊ¨æ';
                                    statusClass = 'paid';
                                    break;
                                case 'refunded':
                                    payStatusText = 'Â∑≤ÈÄÄË≤ª';
                                    statusClass = 'overdue';
                                    break;
                                case 'partial':
                                    payStatusText = 'ÂàÜÊúü‰ªòÊ¨æ';
                                    statusClass = 'overdue';
                                    break;    
                                    
                                default:
                                    payStatusText = item.payStatus;
                                    statusClass = 'pending';
                            }

                            row.innerHTML = `
						<td>\${item.noticeNo}</td>
						<td><strong>\${item.studentName}</strong></td>
						<td>\${item.courseName}</td>
						<td class="amount-paid">NT$ \${parseInt(item.netAmount).toLocaleString()}</td>
						<td class="amount-paid">NT$ 0</td>
						<td class="amount-unpaid">NT$ \${parseInt(item.netAmount).toLocaleString()}</td>
						<td>\${item.payDate}</td>
						<td><span class="status\${statusClass}">\${payStatusText}</span></td>
						<td class="remark-cell" title="\${item.remark || ''}">\${item.remark || "-"}</td>
						<td>
							<button class="btn btn-sm btn-warning editBtn" data-id="\${item.id}" data-subject-id="\${item.courseId}">
								<i class="bi bi-pencil"></i>
							</button>
							<button class="btn btn-sm btn-danger deleteBtn" data-id="\${item.id}">
								<i class="bi bi-trash"></i>
							</button>
						</td>
					`;

                            // Ê∑ªÂä†ÂãïÁï´Âª∂ÈÅ≤
                            row.style.opacity = '0';
                            row.style.transform = 'translateY(20px)';
                            tableBody.appendChild(row);

                            setTimeout(() => {
                                row.style.transition = 'all 0.5s ease';
                                row.style.opacity = '1';
                                row.style.transform = 'translateY(0)';
                            }, index * 100);
                        });

                        // Á∂ÅÂÆö‰∫ã‰ª∂Âà∞ÊåâÈàï‰∏ä
                        bindTableEvents();
                    })
                    .catch(error => {
                        console.error('ËºâÂÖ•Â≠∏Ë≤ªË≥áÊñôÂ§±Êïó:', error);
                        tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 3rem; color: #ef4444;">‚ùå ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢</td></tr>';
                    });
            }

         // Ë®àÁÆó‰∏¶Êõ¥Êñ∞Áµ±Ë®àÊï∏Êìö 
          function updateStatistics(data) {
                let unpaidTotal = 0;      // ÂæÖÊî∂ÈáëÈ°çÔºàÂÆåÂÖ®Êú™‰ªòÔºâ
                let partialTotal = 0;     // ÂàÜÊúüÊú™‰ªòÔºàÈÉ®ÂàÜÂ∑≤‰ªòÔºâ
                let paidTotal = 0;        // Â∑≤Êî∂Á∏ΩÈ°ç
                let overdueTotal = 0;     // ÈÄæÊúüÈáëÈ°ç

                const today = new Date();

                data.forEach(item => {
                    const amount = parseInt(item.netAmount) || 0;
                    const dueDate = new Date(item.payDate);
                    const isOverdue = dueDate < today;

                    switch (item.payStatus) {
                        case 'unpaid':
                            unpaidTotal += amount;
                            if (isOverdue) {
                                overdueTotal += amount;
                            }
                            break;
                        case 'paid':
                            paidTotal += amount;
                            break;
                        case 'partial':
                            partialTotal += amount;
                            if (isOverdue) {
                                overdueTotal += (amount * 0.5); // ÂÅáË®≠ÈÉ®ÂàÜÂ∑≤‰ªòÂâ©È§ò‰∏ÄÂçä
                            }
                            break;
                        case 'refunded':
                            // Â∑≤ÈÄÄË≤ª‰∏çË®àÂÖ•Áµ±Ë®à
                            break;
                        default:
                            unpaidTotal += amount;
                            if (isOverdue) {
                                overdueTotal += amount;
                            }
                    }
                });

                // Êõ¥Êñ∞Áµ±Ë®àÂç°ÁâáÔºåÂ∏∂ÊúâÂãïÁï´ÊïàÊûú
                animateCounter('unpaidAmount', unpaidTotal);
                animateCounter('partialAmount', partialTotal);
                animateCounter('paidAmount', paidTotal);
                animateCounter('overdueAmount', overdueTotal);
            }
            // Êï∏Â≠óÂãïÁï´ÊïàÊûú
               function animateCounter(elementId, targetValue) {
                   const element = document.getElementById(elementId);
                   const startValue = 0;
                   const duration = 1000; // 1Áßí
                   const startTime = performance.now();

                   function updateCounter(currentTime) {
                       const elapsedTime = currentTime - startTime;
                       const progress = Math.min(elapsedTime / duration, 1);

                       // ‰ΩøÁî®Á∑©ÂãïÂáΩÊï∏
                       const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                       const currentValue = startValue + (targetValue - startValue) * easeOutQuart;

                       element.textContent =`NT$ \${Math.floor(currentValue).toLocaleString()}`;

                       if (progress < 1) {
                           requestAnimationFrame(updateCounter);
                       } else {
                           element.textContent = `NT$ \${targetValue.toLocaleString()}`;
                       }
                   }

                   requestAnimationFrame(updateCounter);
               }
         
        
              
            
            
            
            
			function updateTuition(event) {
					    event.preventDefault();
					    
					    const form = document.getElementById('editForm'); 
					    const paymentId = form.querySelector("input[name='payment_id']").value;
					    console.log("paymentId:", paymentId);
					    
		    
					    // ÊßãÂª∫ JSON Ë≥áÊñô
					    const updateData = {
					        id: parseInt(paymentId),
					        payDate: document.querySelector("#editForm input[name='pay_date']").value,
					        payStatus: document.querySelector("#editForm select[name='pay_status']").value,
					        netAmount: document.querySelector("#editForm input[name='amount']").value,
					        remark: document.querySelector("#editForm textarea[name='remark']").value,
					          
					    };
					    
					    // ‚ö†Ô∏è Ë´ã‰ªîÁ¥∞Ê™¢Êü•ÊÇ®ÁöÑÂæåÁ´Ø `EditPaymentNotice` API È†êÊúüÊé•Êî∂ÁöÑ JSON ÁµêÊßã
					    // ÁâπÂà•ÊòØ paymentItems ÊòØÂñÆ‰∏ÄÈÇÑÊòØÂ§öÂÄãÔºå‰ª•ÂèäÂÖ∂‰ªñÂ≠óÊÆµÁöÑÂêçÁ®±„ÄÇ
					
					    const submitBtn = form.querySelector('button[type="submit"]');
					    const originalText = submitBtn.innerHTML;
					    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Êõ¥Êñ∞‰∏≠...';
					    submitBtn.disabled = true;
					
					  
					    
					    // ÊÇ®ÈÄôË£°ÁöÑ oldData Âíå operator ÂèÉÊï∏ÔºåÂ¶ÇÊûúÂæåÁ´ØÈúÄË¶ÅÔºåÊáâÁ¢∫‰øùÂÖ∂Ê≠£Á¢∫ÊÄß
					  //  const encodedOldData = encodeURIComponent(JSON.stringify({})); // Ê†πÊìöÂØ¶ÈöõÊÉÖÊ≥ÅÂ°´ÂÖÖ oldData
					    const encodedOldData = "OldDate"; // Ê†πÊìöÂØ¶ÈöõÊÉÖÊ≥ÅÂ°´ÂÖÖ oldData
					    const encodedOperator = encodeURIComponent('admin'); // Ê†πÊìöÂØ¶ÈöõÊìç‰Ωú‰∫∫Âì°Â°´ÂÖÖ
					
					    
					    fetch(`${pageContext.request.contextPath}/apiEditPayment/\${paymentId}?oldData=\${encodedOldData}&operator=\${encodedOperator}`, {
					        method: "PUT",
					        headers: {
					            "Content-Type": "application/json"
					        },
					        body: JSON.stringify(updateData)
					    })
					    .then(res => res.json())
					    .then(data => {
					        console.log("Server ÂõûÂÇ≥Ôºö", data);
					        if (data.success) {
					            showNotification('Â≠∏Ë≤ªË≥áÊñôÊõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');
					            bootstrap.Modal.getInstance(document.getElementById("editTuitionModal")).hide();
					            loadTuitionData();
					        } else {
					            throw new Error(data.message || 'Êõ¥Êñ∞Â§±Êïó');
					        }
					    })
					    .catch(error => {
					        console.error('Êõ¥Êñ∞Â§±Êïó:', error);
					        showNotification('Êõ¥Êñ∞Â§±ÊïóÔºö' + error.message, 'error');
					    })
					    .finally(() => {
					        submitBtn.innerHTML = originalText;
					        submitBtn.disabled = false;
					    });
			}
			
            function parseChineseDate(str) {
                // ÊîØÊè¥ÂÖ®ÂΩ¢/ÂçäÂΩ¢Á©∫Ê†ºÔºå‰πüÂÆπË®±Â§öÈ§òÁ©∫ÁôΩ
                const match = str.match(/(\d+)Êúà[\s\u3000]*(\d+),[\s\u3000]*(\d{4})/);
                if (!match) return "";
                const month = match[1].padStart(2, "0");
                const day = match[2].padStart(2, "0");
                const year = match[3];
                return `\${year}-\${month}-\${day}`;
            }

            // Â∞á‰∫ã‰ª∂Á∂ÅÂÆöÂàÜÈõ¢ÊàêÁç®Á´ãÂáΩÊï∏
           function bindTableEvents() {
    // Á∑®ËºØÊåâÈàï‰∫ã‰ª∂Ôºà‰øùÊåÅ‰∏çËÆäÔºâ
    document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", function () {
            const row = this.closest("tr");
            const tid = this.getAttribute("data-id");
            const cid = this.getAttribute("data-subject-id");
            
            const studentName = row.children[1].textContent.trim();
            const courseName = row.children[2].textContent.trim();
            const amount = row.children[3].textContent.replace("NT$ ", "").replace(/,/g, "").trim();
            const payDateText = row.children[6].textContent.trim();
            const payDate = parseChineseDate(payDateText);
            const remark = row.children[8].textContent.trim();
            
            const statusMap = {
            	    "ÂæÖÁπ≥‰∏≠": "unpaid",
            	    "Â∑≤Áπ≥Ê∏Ö": "paid",
            	    "ÂàÜÊúü‰ªòÊ¨æ": "partial",
            	    "Â∑≤ÈÄÄË≤ª": "refunded"
            	};
            
       	   const payStatusText = row.children[7].textContent.trim();
            const payStatusValue = statusMap[payStatusText];

            // Â°´ÂÖ•Ë≥áÊñô
            
            document.querySelector("#editForm input[name='payment_id']").value = tid;  //ÈÄöÁü•ÂñÆid
            document.querySelector("#editForm input[name='course_id']").value = cid;   //Ë™≤Á®ãID
            document.querySelector("#editForm input[name='student_name']").value = studentName;
            document.querySelector("#editForm input[name='course_name']").value = courseName;
            document.querySelector("#editForm input[name='amount']").value = amount;
            document.querySelector("#editForm input[name='pay_date']").value = payDate;
            document.querySelector("#editForm select[name='pay_status']").value = payStatusValue;
            document.querySelector("#editForm textarea[name='remark']").value = remark === "-" ? "" : remark;

            // È°ØÁ§∫ modal
            const editModal = new bootstrap.Modal(document.getElementById("editTuitionModal"));
            editModal.show();
        });
    });

 // ‚úÖ ‰øÆÊ≠£Âà™Èô§ÊåâÈàï‰∫ã‰ª∂
    document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", function () {
            const tid = this.getAttribute("data-id");
            const row = this.closest("tr");
            const studentName = row.children[1].textContent.trim();

            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${studentName} ÁöÑÂ≠∏Ë≤ªË®òÈåÑÂóéÔºü\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                const reason = prompt("Ë´ãËº∏ÂÖ•Âà™Èô§ÂéüÂõ†Ôºö") || "Ë≥áÊñôÊúâË™§";
                const operator = prompt("Ë´ãËº∏ÂÖ•Êìç‰Ωú‰∫∫Âì°ÂêçÁ®±Ôºö") || "admin";

                this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                this.disabled = true;

                const encodedReason = encodeURIComponent(reason);
                const encodedOperator = encodeURIComponent(operator);
                
                // ‚úÖ ‰øÆÊ≠£Ôºö‰ΩøÁî®Ê≠£Á¢∫ÁöÑË∑ØÂæëÊ†ºÂºè
                fetch(`${pageContext.request.contextPath}/apiDeletePayment/\${tid}?reason=\${encodedReason}&operator=\${encodedOperator}`, {
                    method: "DELETE"
                })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        showNotification('Âà™Èô§ÊàêÂäüÔºÅ', 'success');
                        loadTuitionData();
                    } else {
                        throw new Error(result.message || 'Âà™Èô§Â§±Êïó');
                    }
                })
                .catch(error => {
                    console.error('Âà™Èô§Â§±Êïó:', error);
                    showNotification('Âà™Èô§Â§±ÊïóÔºö' + error.message, 'error');
                    this.innerHTML = '<i class="bi bi-trash"></i>';
                    this.disabled = false;
                });
            }
        });
    });
}

            // ÈÄöÁü•ÊèêÁ§∫ÂáΩÊï∏
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.style.cssText = `
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 1rem 1.5rem;
			border-radius: 12px;
			color: white;
			font-weight: 600;
			z-index: 9999;
			transform: translateX(100%);
			transition: all 0.3s ease;
			box-shadow: 0 4px 20px rgba(0,0,0,0.1);
		`;

                switch (type) {
                    case 'success':
                        notification.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
                        notification.innerHTML = `<i class="bi bi-check-circle"></i> \${message}`;
                        break;
                    case 'error':
                        notification.style.background = 'linear-gradient(135deg, #f56565, #e53e3e)';
                        notification.innerHTML = `<i class="bi bi-exclamation-circle"></i> \${message}`;
                        break;
                    default:
                        notification.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        notification.innerHTML = `<i class="bi bi-info-circle"></i> \${message}`;
                }

                document.body.appendChild(notification);

                // È°ØÁ§∫ÂãïÁï´
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                // Ëá™ÂãïÈö±Ëóè
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            // ËºâÂÖ•Â≠∏ÁîüË≥áÊñô
            function loadStudents() {
                fetch("${pageContext.request.contextPath}/api/member/student/all")
                    .then(response => response.json())
                    .then(data => {
                        console.log("ÂâçÁ´ØÊî∂Âà∞Â≠∏ÁîüË≥áÊñôÔºö", data);
                        const dropdown = document.getElementById("studentDropdown");
                        data.data.forEach(student => {
                            const option = document.createElement("option");
                            option.value = student.id;
                            option.textContent = student.name;
                            dropdown.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("ËºâÂÖ•Â≠∏ÁîüË≥áÊñôÂ§±ÊïóÔºö", error);
                    });
            }

            // ËºâÂÖ•Ë™≤Á®ãË≥áÊñô
            function loadCourses() {
                fetch("${pageContext.request.contextPath}/api/course/all")
                    .then(response => response.json())
                    .then(data => {
                        console.log("ÂâçÁ´ØÊî∂Âà∞Ë™≤Á®ãË≥áÊñôÔºö", data);
                        const dropdown = document.getElementById('courseDropdown');
                        data.data.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course.id;
                            option.textContent = course.name;
                            dropdown.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('ËºâÂÖ•Ë™≤Á®ãË≥áÊñôÂ§±Êïó:', error);
                    });
            }

            // ËºâÂÖ•ÁßëÁõÆË≥áÊñô
            function loadSubjects() {
                fetch("${pageContext.request.contextPath}/api/course/subject/all")
                    .then(response => response.json())
                    .then(data => {
                        console.log("ÂâçÁ´ØÊî∂Âà∞ÁßëÁõÆË≥áÊñôÔºö", data);
                        const dropdown = document.getElementById('subject');
                        data.data.forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject.id;
                            option.textContent = subject.name;
                            dropdown.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('ËºâÂÖ•ÁßëÁõÆË≥áÊñôÂ§±Êïó:', error);
                    });
            }

            // Êñ∞Â¢ûË≤ªÁî®È†ÖÁõÆ
            document.getElementById("addFeeBtn").addEventListener("click", function () {
                const subjectSelect = document.getElementById("subject");
                const amountInput = document.getElementById("amount");
                const subjectText = subjectSelect.options[subjectSelect.selectedIndex].text;
                const amount = amountInput.value;

                // È©óË≠âËº∏ÂÖ•
                if (subjectSelect.value === "" || subjectSelect.value === "Ë´ãÈÅ∏ÊìáÁßëÁõÆ" || !amount) {
                    showNotification("Ë´ãÈÅ∏ÊìáÁßëÁõÆ‰∏¶Ëº∏ÂÖ•ÈáëÈ°çÔºÅ", "error");
                    return;
                }

                // Âª∫Á´ãÈ†ÖÁõÆ
                const feeItem = document.createElement("div");
                feeItem.className = "fee-item";
                feeItem.innerHTML = `
			<div><i class="bi bi-journal-text me-2"></i>\${subjectText}</div>
			<div class="text-primary fw-bold">NT$ \${parseInt(amount).toLocaleString()}</div>
			<input type="hidden" name="subjectList" value="\${subjectSelect.value}">
			<input type="hidden" name="amountList" value="\${amount}">
			<button type="button" class="btn btn-danger btn-sm ms-2">
				<i class="bi bi-trash"></i>
			</button>
		`;

                // Âä†ÂÖ•ÂàóË°®
                document.getElementById("feeList").appendChild(feeItem);

                // Ê∏ÖÁ©∫Ê¨Ñ‰Ωç
                subjectSelect.selectedIndex = 0;
                amountInput.value = "";

                // Âà™Èô§ÂäüËÉΩ
                feeItem.querySelector(".btn-danger").addEventListener("click", function () {
                    feeItem.style.transform = 'scale(0)';
                    feeItem.style.opacity = '0';
                    setTimeout(() => {
                        feeItem.remove();
                    }, 300);
                });

                // Ê∑ªÂä†ÂãïÁï´
                feeItem.style.opacity = '0';
                feeItem.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    feeItem.style.transition = 'all 0.3s ease';
                    feeItem.style.opacity = '1';
                    feeItem.style.transform = 'translateY(0)';
                }, 100);
            });

            // Êñ∞Â¢ûÂ≠∏Ë≤ªË°®ÂñÆÊèê‰∫§
           function insert(event) {
    event.preventDefault();

    const form = document.getElementById('feeForm');
    const formData = new FormData(form);
    
    // ‚úÖ ÈáçË¶ÅÔºöÂæûÂãïÊÖãÊ∑ªÂä†ÁöÑË≤ªÁî®ÂàóË°®‰∏≠Êî∂ÈõÜ paymentItems
    const paymentItems = [];
    const feeItems = document.querySelectorAll('#feeList .fee-item');
    
    console.log('ÊâæÂà∞Ë≤ªÁî®È†ÖÁõÆÊï∏Èáè:', feeItems.length); // Ë™øË©¶Áî®
    
    feeItems.forEach(item => {
        const subjectId = item.querySelector('input[name="subjectList"]').value;
        const amount = item.querySelector('input[name="amountList"]').value;
        
        if (subjectId && amount) {
            paymentItems.push({
                subjectId: parseInt(subjectId),
                amount: String(amount),
                remark: "",
                payStatus: "unpaid"
            });
        }
    });
    
    console.log('ÊßãÂª∫ÁöÑ paymentItems:', paymentItems); // Ë™øË©¶Áî®
    
    // ‚úÖ Ê™¢Êü•ÊòØÂê¶ÊúâË≤ªÁî®È†ÖÁõÆ
    if (paymentItems.length === 0) {
        showNotification('Ë´ãËá≥Â∞ëÊ∑ªÂä†‰∏ÄÂÄãË≤ªÁî®È†ÖÁõÆÔºÅ', 'error');
        return;
    }
    
    // ‚úÖ Ë®àÁÆó net_amount
    const totalAmount = paymentItems.reduce((sum, item) => sum + parseInt(item.amount), 0);
    const discountScholar = parseInt(formData.get('discount_scholar') || '0');
    const discountSibling = parseInt(formData.get('discount_sibling') || '0');
    const netAmount = totalAmount - discountScholar - discountSibling;
    
    console.log('Ë®àÁÆóÁµêÊûú:', { totalAmount, discountScholar, discountSibling, netAmount }); // Ë™øË©¶Áî®
    
    // ‚úÖ ÊßãÂª∫Ë´ãÊ±ÇÂèÉÊï∏
    const params = new URLSearchParams();
    params.append('student_id', formData.get('student_id'));
    params.append('due_date', formData.get('due_date'));
    params.append('course_id', formData.get('course_id'));
    params.append('start_date', formData.get('start_date'));
    params.append('end_date', formData.get('end_date'));
    params.append('discount_scholar', discountScholar.toString());
    params.append('discount_sibling', discountSibling.toString());
    params.append('net_amount', netAmount.toString());
    params.append('remark', formData.get('remark') || '');
    params.append('paymentItems', JSON.stringify(paymentItems)); // ‚úÖ ÈóúÈçµÔºöÊ∑ªÂä† JSON Â≠ó‰∏≤
    params.append('operator', 'admin');
    
    console.log('ÁôºÈÄÅÁöÑÂèÉÊï∏:', params.toString()); // Ë™øË©¶Áî®

    // Ê∑ªÂä†ËºâÂÖ•ÁãÄÊÖã
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ÂâµÂª∫‰∏≠...';
    submitBtn.disabled = true;

    fetch("${pageContext.request.contextPath}/apicreatePayment", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: params.toString()
    })
    .then(res => {
        console.log('Response status:', res.status); // Ë™øË©¶Áî®
        return res.json();
    })
    .then(data => {
        console.log("Server ÂõûÂÇ≥Ôºö", data);
        if (data.success) {
            showNotification('Â≠∏Ë≤ªÂ∏≥ÂñÆÂâµÂª∫ÊàêÂäüÔºÅ', 'success');
            bootstrap.Modal.getInstance(document.getElementById("tuitionModal")).hide();
            loadTuitionData();

            // Ê∏ÖÁ©∫Ë°®ÂñÆ
            form.reset();
            document.getElementById("feeList").innerHTML = "";
        } else {
            throw new Error(data.message || 'ÂâµÂª∫Â§±Êïó');
        }
    })
    .catch(error => {
        console.error('ÂâµÂª∫Â§±Êïó:', error);
        showNotification('ÂâµÂª∫Â§±ÊïóÔºö' + error.message, 'error');
    })
    .finally(() => {
        // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

          
            

            // ÊêúÂ∞ãÂäüËÉΩ
            document.querySelector('.search-input').addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                const tableRows = document.querySelectorAll('#tuitionTable tbody tr');

                tableRows.forEach(row => {
                    if (row.children.length < 10) return; // Ë∑≥ÈÅéËºâÂÖ•‰∏≠ÊàñÁ©∫ÁôΩË°å

                    const studentName = row.children[1].textContent.toLowerCase();
                    const subjectName = row.children[2].textContent.toLowerCase();
                    const notificationId = row.children[0].textContent.toLowerCase();

                    const isMatch = studentName.includes(searchTerm) ||
                        subjectName.includes(searchTerm) ||
                        notificationId.includes(searchTerm);

                    if (isMatch) {
                        row.style.display = '';
                        row.style.opacity = '1';
                    } else {
                        row.style.display = 'none';
                        row.style.opacity = '0';
                    }
                });

                // Â¶ÇÊûúÊêúÂ∞ãÁµêÊûúÁÇ∫Á©∫ÔºåÈ°ØÁ§∫ÊèêÁ§∫
                const visibleRows = Array.from(tableRows).filter(row =>
                    row.style.display !== 'none' && row.children.length >= 10
                );

                if (searchTerm && visibleRows.length === 0) {
                    const tbody = document.querySelector('#tuitionTable tbody');
                    let noResultRow = tbody.querySelector('.no-result-row');

                    if (!noResultRow) {
                        noResultRow = document.createElement('tr');
                        noResultRow.className = 'no-result-row';
                        noResultRow.innerHTML = '<td colspan="10" style="text-align: center; padding: 3rem; color: #718096;">üîç Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑ</td>';
                        tbody.appendChild(noResultRow);
                    }
                    noResultRow.style.display = '';
                } else {
                    const noResultRow = document.querySelector('.no-result-row');
                    if (noResultRow) {
                        noResultRow.style.display = 'none';
                    }
                }
            });

            // Modal ÈáçÁΩÆÂäüËÉΩ
            document.getElementById('tuitionModal').addEventListener('hidden.bs.modal', function () {
                const form = document.getElementById('feeForm');
                form.reset();
                document.getElementById('feeList').innerHTML = '';
            });

            document.getElementById('editTuitionModal').addEventListener('hidden.bs.modal', function () {
                const form = document.getElementById('editForm');
                form.reset();
            });
        </script>